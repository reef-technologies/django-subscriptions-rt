from __future__ import annotations

from base64 import b64decode
from enum import Enum
from typing import Any

from pydantic import BaseModel, Extra


class GoogleSubscriptionNotificationType(int, Enum):
    RECOVERED = 1
    RENEWED = 2
    CANCELED = 3
    PURCHASED = 4
    ON_HOLD = 5
    IN_GRACE_PERIOD = 6
    RESTARTED = 7
    PRICE_CHANGE_CONFIRMED = 8
    DEFERRED = 9
    PAUSED = 10
    PAUSE_SCHEDULE_CHANGED = 11
    REVOKED = 12
    EXPIRED = 13


class GoogleSubscriptionNotification(BaseModel):
    version: str
    notificationType: GoogleSubscriptionNotificationType
    purchaseToken: str
    subscriptionId: str

    class Config:
        extra = Extra.forbid


class GoogleTestNotification(BaseModel):
    version: str

    class Config:
        extra = Extra.forbid


class VoidedPurchaseNotification(BaseModel):
    purchaseToken: str
    orderId: str
    productType: int

    class Config:
        extra = Extra.forbid


class GoogleDeveloperNotification(BaseModel):
    # https://developer.android.com/google/play/billing/rtdn-reference#sub
    version: str
    packageName: str
    eventTimeMillis: str
    oneTimeProductNotification: Any | None = None
    subscriptionNotification: GoogleSubscriptionNotification | None = None
    voidedPurchaseNotification: VoidedPurchaseNotification | None = None
    testNotification: GoogleTestNotification | None = None

    class Config:
        extra = Extra.forbid


class GooglePubSubMessage(BaseModel):
    data: str
    messageId: str
    publishTime: str

    class Config:
        extra = Extra.ignore

    def decode(self) -> str:
        return b64decode(self.data).decode("utf8")


class GooglePubSubData(BaseModel):
    message: GooglePubSubMessage
    subscription: str

    class Config:
        extra = Extra.forbid


class AppNotification(BaseModel):
    purchase_token: str

    class Config:
        extra = Extra.forbid


class MultiNotification(BaseModel):
    notification: AppNotification | GooglePubSubData

    class Config:
        extra = Extra.forbid


class GoogleBasePlanState(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#State
    STATE_UNSPECIFIED = "STATE_UNSPECIFIED"
    DRAFT = "DRAFT"
    ACTIVE = "ACTIVE"
    INACTIVE = "INACTIVE"


class GoogleMoney(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/Money
    currencyCode: str  # ISO4217
    units: str
    nanos: int | None = None

    class Config:
        extra = Extra.forbid


class GoogleRegionalBasePlanConfig(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#RegionalBasePlanConfig
    regionCode: str  # ISO3166-2
    newSubscriberAvailability: bool
    price: GoogleMoney

    class Config:
        extra = Extra.forbid


class GoogleResubscribeState(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#ResubscribeState
    UNSPECIFIED = "RESUBSCRIBE_STATE_UNSPECIFIED"
    ACTIVE = "RESUBSCRIBE_STATE_ACTIVE"
    INACTIVE = "RESUBSCRIBE_STATE_INACTIVE"


class GoogleSubscriptionProrationMode(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#SubscriptionProrationMode
    UNSPECIFIED = "SUBSCRIPTION_PRORATION_MODE_UNSPECIFIED"
    CHARGE_ON_NEXT_BILLING_DATE = "SUBSCRIPTION_PRORATION_MODE_CHARGE_ON_NEXT_BILLING_DATE"
    CHARGE_FULL_PRICE_IMMEDIATELY = "SUBSCRIPTION_PRORATION_MODE_CHARGE_FULL_PRICE_IMMEDIATELY"


class GoogleAutoRenewingBasePlanType(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#AutoRenewingBasePlanType
    billingPeriodDuration: str
    gracePeriodDuration: str
    resubscribeState: GoogleResubscribeState
    prorationMode: GoogleSubscriptionProrationMode
    legacyCompatible: bool
    legacyCompatibleSubscriptionOfferId: str

    class Config:
        extra = Extra.forbid


class GoogleTimeExtension(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#TimeExtension
    UNSPECIFIED = "TIME_EXTENSION_UNSPECIFIED"
    ACTIVE = "TIME_EXTENSION_ACTIVE"
    INACTIVE = "TIME_EXTENSION_INACTIVE"


class GooglePrepaidBasePlanType(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#PrepaidBasePlanType
    billingPeriodDuration: str
    timeExtension: GoogleTimeExtension

    class Config:
        extra = Extra.forbid


class GoogleBasePlan(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions#BasePlan
    basePlanId: str
    state: GoogleBasePlanState
    regionalConfigs: list[GoogleRegionalBasePlanConfig]
    autoRenewingBasePlanType: GoogleAutoRenewingBasePlanType | None
    prepaidBasePlanType: GooglePrepaidBasePlanType | None

    class Config:
        extra = Extra.ignore


class GoogleSubscription(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/monetization.subscriptions
    packageName: str
    productId: str
    basePlans: list[GoogleBasePlan]
    archived: bool | None = None

    class Config:
        extra = Extra.ignore


class GoogleSubscriptionState(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#SubscriptionState
    UNSPECIFIED = "SUBSCRIPTION_STATE_UNSPECIFIED"
    PENDING = "SUBSCRIPTION_STATE_PENDING"
    ACTIVE = "SUBSCRIPTION_STATE_ACTIVE"
    PAUSED = "SUBSCRIPTION_STATE_PAUSED"
    IN_GRACE_PERIOD = "SUBSCRIPTION_STATE_IN_GRACE_PERIOD"
    ON_HOLD = "SUBSCRIPTION_STATE_ON_HOLD"
    CANCELED = "SUBSCRIPTION_STATE_CANCELED"
    EXPIRED = "SUBSCRIPTION_STATE_EXPIRED"


class GoogleAcknowledgementState(str, Enum):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#AcknowledgementState
    UNSPECIFIED = "ACKNOWLEDGEMENT_STATE_UNSPECIFIED"
    PENDING = "ACKNOWLEDGEMENT_STATE_PENDING"
    ACKNOWLEDGED = "ACKNOWLEDGEMENT_STATE_ACKNOWLEDGED"


class GoogleAutoRenewingPlan(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#AutoRenewingPlan
    autoRenewEnabled: bool | None = None

    class Config:
        extra = Extra.forbid


class GooglePrepaidPlan(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#PrepaidPlan
    allowExtendAfterTime: bool

    class Config:
        extra = Extra.forbid


class GoogleOfferDetails(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#OfferDetails
    offerTags: list[str] = []
    basePlanId: str
    offerId: str | None = None

    class Config:
        extra = Extra.forbid


class GoogleSubscriptionPurchaseLineItem(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#SubscriptionPurchaseLineItem
    productId: str
    expiryTime: str
    autoRenewingPlan: GoogleAutoRenewingPlan | None = None
    prepaidPlan: GooglePrepaidPlan | None = None
    offerDetails: GoogleOfferDetails

    class Config:
        extra = Extra.forbid


class GoogleSubscriptionPurchaseV2(BaseModel):
    # https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2#resource:-subscriptionpurchasev2
    lineItems: list[GoogleSubscriptionPurchaseLineItem]
    startTime: str
    subscriptionState: GoogleSubscriptionState
    linkedPurchaseToken: str | None = None
    acknowledgementState: GoogleAcknowledgementState

    class Config:
        extra = Extra.ignore


class Metadata(BaseModel):
    purchase: GoogleSubscriptionPurchaseV2

    class Config:
        extra = Extra.forbid
